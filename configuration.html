<!DOCTYPE html>
<html>

<head>
	<title>Config page</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>
	<div data-role="page" id="main">
		<div data-role="header">
			<h1>Config</h1>
		</div>
		<div role="main" class="ui-content">
			<div id="url">
				URL:
			</div>
			<form id="mainForm" action="javascript:saveOptions();">
				<div class="ui-field-contain">
					<label for="fsGrade">Fahrenheit / Celsius:</label>
					<fieldset data-role="controlgroup" data-type="horizontal" name="fsGrade" id="fsGrade">
						<input type="radio" name="scale" id="F">
						<label for="F">&deg;F</label>
						<input type="radio" name="scale" id="C">
						<label for="C">&deg;C</label>
					</fieldset>
				</div>
				<div class="ui-field-contain">
					<label for="numberOfDays">Number of forecast days:</label>
					<select name="numberOfDays" id="numberOfDays">
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
						<option value="13">13</option>
						<option value="14">14</option>
						<option value="15">15</option>
						<option value="16">16</option>
					</select>
				</div>
				<div class="ui-grid-b">
					<div class="ui-block-a">
						new city:
					</div>
					<div class="ui-block-b">
						<label for="newCity" class="ui-hidden-accessible">New city:</label>
						<input type="text" name="newCity" id="newCity" placeholder="Add new city...">
					</div>
					<div class="ui-block-c">
						<input type="button" class="ui-btn ui-corner-all" value="Add" onclick="javascript:checkCity();">
					</div>
				</div>
				<div id="storedCities">
					Stored Cities:
					<ul data-role="listview" data-inset="true" id="cityList">
					</ul>
				</div>
				<div>
					<input type="submit" class="ui-btn ui-corner-all" value="Save">
				</div>
			</form>
		</div>
		<div data-role="footer">
			<h4>Have fun!</h4>
		</div>
	</div>
	<script>
	function checkCity() {
		var newCity = '<li><h5>' + $('#newCity').val() + '<//h5><//li>';
		$('#cityList').append(newCity);
		$('#storedCities').show();
		$('#newCity').val('');
	};

	function saveOptions() {
		var options = {};
		//Add all textual values
		$('textarea, select, [type="hidden"], [type="password"], [type="text"], [type="number"]')
			.each(function() {
				options[$(this).attr('id')] = $(this).val();
			})
			//Add all checkbox type values
		$('[type="radio"], [type="checkbox"]').each(function() {
			options[$(this).attr('id')] = $(this).is(':checked');
		})
		console.log(options);
		var opts = JSON.stringify(options);
		console.log(opts);
		var location = "pebblejs://close#" + encodeURIComponent(opts);
		console.log("Warping to: " + location);
		console.log(location);
		document.location = location;
	};
	$().ready(function() {
		$(window).keydown(function(event) {
			if (event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
		$('#newCity').keyup(function(e) {
			if (e.which == 13) {
				checkCity();
			}
		});
		//hide storedCities in case it is empty
		$('#storedCities').hide();

		//Set form values to whatever is passed in.
		//Checkboxes:
		//$( "input[type='checkbox']" ).prop( "checked", true ).checkboxradio( "refresh" );
		//
		//
		//Radios:
		//$( "input[type='radio']" ).prop( "checked", true ).checkboxradio( "refresh" );
		//
		//
		//Selects:
		//var myselect = $( "#selectfoo" );
		//myselect[0].selectedIndex = 3;
		//myselect.selectmenu( "refresh" );
		//
		//
		//Sliders:
		//$( "input[type='range']" ).val( 60 ).slider( "refresh" );
		//
		//
		//Flip switches:
		//They use the slider widget.
		//var myswitch = $( "#selectbar" );
		//myswitch[ 0 ].selectedIndex = 1;
		//myswitch.slider( "refresh" );
		var myUrl = decodeURIComponent(window.location.search.substring(1));
		var obj = jQuery.parseJSON(myUrl);
		$('#url').append('<p>numberOfDays:' + obj.numberOfDays + '<//p>');
		for (key in obj) {
			var el = $("#" + [key]);
			var val = obj[key];
			if (el.is("select")) {
				el[0].selectedIndex = val;
				el.selectmenu("refresh");
			} else if (el.attr("type") === "radio") {
				el.prop("checked", val).checkboxradio("refresh");
			} else if (key === 'cities' && val.length > 0){
				$.each(val, function(i, arrVal) {
					var newCity = '<li><h5>' + arrVal + '<//h5><//li>';
					$('#cityList').append(newCity);
				});
				$('#storedCities').show();
			} else {
				el.val(val);
			}
		}
	});
	</script>
</body>

</html>
