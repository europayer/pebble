<!DOCTYPE html>
<html>

<head>
	<title>Config page</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="UTF-8">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<style type="text/css">
	.pebbleWatch {
		background-image: url("watch.png");
		height: 372px;
		width: 236px;
	}
	.pebblePreviewFrame {
		padding-top: 103px;
		padding-left: 1px;
		margin: 0 auto;
		height: 168px;
		width: 144px;
		border: 0px;
		overflow: hidden;
	}
	.pebblePreviewFrame .pebblePreviewContent {
		width: 159px;
		height: 168px;
		overflow: scroll;
		padding-bottom: 15px;
		background-color: #fff;
	}
	.wordwrapPebble {
		width: 144px;
		word-wrap: break-word;
		white-space: pre-wrap;
		/* CSS3 */
		
		white-space: -moz-pre-wrap;
		/* Firefox */
		
		white-space: -pre-wrap;
		/* Opera <7 */
		
		white-space: -o-pre-wrap;
		/* Opera 7 */
	}
	.sosWrapper {
		width: 159px;
		height: 28px;
	}
	.sosImg {
		width: 28px;
		height: 28px;
		float: left;
		background-image: url("sos.png");
	}
	.pebbleTitle {
		font-weight: bold;
		font-size: 21px;
		width: 120px;
		float: left;
	}
	.pebbleText {
		font-weight: normal;
		font-size: 21px;
	}
	</style>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="https://rawgit.com/europayer/pebble/master/jquery-ui-custom-punch.js"></script>
	<script>
	var options = {};

	var addCity = function(newCityId, newCityName, remove) {
		if (remove) {
			$("#found" + newCityId).fadeOut('slow', function() {
				$("#found" + newCityId).remove();
			});
			$('#foundCityList').listview('refresh');
		}
		var delCityFn = "javascript:removeCity('" + newCityId + "');"
		var newCityItem = '<li id="' + newCityId + '"><a href="#"><span class="ui-icon-bars ui-btn-icon-left" style="position:relative;" />' + newCityName + '<//a><a href="' + delCityFn + '"<//a><//li>';
		$('#storedCityList').append(newCityItem);
		$('#storedCityList').listview('refresh');
		if (!$('#storedCityDiv').is(':visible')) {
			$('#storedCityDiv').fadeIn('slow');
		}
	};

	var removeCity = function(item, transition) {
		$("#" + item).fadeOut("slow", function() {
			$("#" + item).remove();
			$("#storedCityList").listview("refresh");
			if ($('#storedCityList').children().length === 0) {
				$('#storedCityDiv').hide();
			}
		});
	};

	var cityResultCallback = function(data) {
		var tempCities = [];
		$('#storedCityList').children().each(function(i, val) {
			tempCities.push(val.id);
		});
		if (data.RESULTS.length > 1) {
			$('#foundCityList').empty();
			$.each(data.RESULTS, function(i, cityDetails) {
				if (cityDetails.zmw) {
					var cId = encodeCId(cityDetails.zmw);
					var cityItem = '';
					if (tempCities.indexOf(cId) < 1) {
						var addCityFn = "javascript:addCity('" + cId + "','" + cityDetails.name + "', 'true');"
						cityItem = '<li id="found' + cId + '"><a href="#">' + cityDetails.name + '<//a><a href="' + addCityFn + '"<//a><//li>';
					}
					$('#foundCityList').append(cityItem);
				}
			});
			$('#foundCityList').listview('refresh');
			$('#foundCityDiv label').html('Found ' + data.RESULTS.length + ' cities starting with "' + options.serachCityValue + '".<br />Please select one to add to stored cities.');
			$('#foundCityDiv').show();
			$('#foundNoCityDiv').hide();
			$('#foundOneCityDiv').hide();
		} else if (data.RESULTS.length == 1) {
			var cId = encodeCId(data.RESULTS[0].zmw);
			if (tempCities.indexOf(cId) < 1) {
				addCity(cId, data.RESULTS[0].name);
				$('#foundOneCityDiv').html("Added '" + data.RESULTS[0].name + "'.");

			} else {
				$('#foundOneCityDiv').html("'" + data.RESULTS[0].name + "' already in stored city list.");
			}
			$('#foundOneCityDiv').show();
			$('#foundCityDiv').hide();
			$('#foundNoCityDiv').hide();
		} else {
			$('#foundOneCityDiv').hide();
			$('#foundCityDiv').hide();
			$('#foundNoCityDiv').html("<b>No city found starting with '" + options.serachCityValue + "'! Please check your spelling.<//b>");
			$('#foundNoCityDiv').show();
		}
	};

	function saveOptions() {
		//Add all textual values
		$('textarea, select, [type="hidden"], [type="password"], [type="text"], [type="number"]').each(function() {
			options[$(this).attr('id')] = $(this).val();
		});
		//Add all checkbox type values
		$('[type="radio"], [type="checkbox"]').each(function() {
			options[$(this).attr('id')] = $(this).is(':checked');
		});
		options.cities = [];
		$('#storedCityList').children().each(function(i, val) {
			options.cities.push([decodeCId(val.id), val.textContent]);
		});
		console.log(options);
		var opts = JSON.stringify(options);
		var location = "pebblejs://close#" + encodeURIComponent(opts);
		console.log("Warping to: " + location);
		document.location = location;
	};

	function encodeCId(id) {
		return 'id' + id.replace(/\./g, "-");
	};

	function decodeCId(id) {
		return id.substring(2).replace(/-/g, ".");
	};

	$(document).ajaxStart(function() {
		$.mobile.loading('show');
	});

	$(document).ajaxStop(function() {
		$.mobile.loading('hide');
	});

	$(document).bind('pageinit', function() {
		$("#storedCityList").sortable();
		$("#storedCityList").disableSelection();
		$("#storedCityList").bind("sortstop", function(event, ui) {
			$('#storedCityList').listview('refresh');
		});

		var searching = null;
		$("#autocomplete").on("filterablebeforefilter", function(e, data) {
			if (searching) {
				clearTimeout(searching);
			}
			options.serachCityValue = $(data.input).val();
			if (options.serachCityValue && options.serachCityValue.length > 2) {
				searching = setTimeout(function() {
					$(this).html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'><//span><//div><//li>");
					var query = {
						'format': 'JSON',
						'cb': 'cityResultCallback',
						'query': options.serachCityValue.toLowerCase().replace(/ä/g, "ae").replace(/ö/g, "oe").replace(/ü/g, "ue"),
						'h': '0'
					};

					$.ajax({
						url: "http://autocomplete.wunderground.com/aq",
						dataType: "jsonp",
						data: query
					});
				}, 500);
			}
		});
	});

	$().ready(function() {
		$('.noDefaultAction').on('keydown', function(event) {
			if (event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
		//hide storedCityList in case it is empty
		$('#storedCityDiv').hide();
		$('#foundCityDiv').hide();
		$('#foundNoCityDiv').hide();

		$('.ui-input-clear').on('tap', function() {
			$('#foundCityList').empty();
			$('#foundCityDiv').hide();
		});

		$('#sosTitle').keyup(function() {
			$('#prevSosTitle').html($('#sosTitle').val());
		});

		$('#sosText').keyup(function(event) {
			$('#prevSosText').html($('#sosText').val());
		});

		//Preset fields 
		for (i = 1; i <= 16; i++) {
			var counter = '<option value=' + i + '>' + i + '<//option>';
			$('#numberOfDays').append(counter);
		};

		var myUrl = decodeURIComponent(window.location.search.substring(1));
		var obj = jQuery.parseJSON(myUrl);
		var titleFound = false,
			textFound = false;
		for (key in obj) {
			var el = $("#" + [key]);
			var val = obj[key];
			if (el.is("select")) {
				el[0].selectedIndex = val - 1;
				el.selectmenu("refresh");
			} else if (el.attr("type") === "radio") {
				el.prop("checked", val).checkboxradio("refresh");
			} else if (key === 'cities' && val.length > 0) {
				$.each(val, function(i, arrVal) {
					var cId = arrVal[0];
					var cName = arrVal[1];
					addCity(encodeCId(cId), cName);
				});
				$('#storedCityList').show();
			} else {
				el.val(val);
			}
			if (key === 'sosTitle' && val) {
				titleFound = true;
			}
			if (key === 'sosText' && val) {
				textFound = true;
			}
			$('#sosTitle').keyup();
			$('#sosText').keyup();
			$('#storedCityList').listview('refresh');
		}
		if (!titleFound) {
			$('#prevSosTitle').html('Emergency Info:');
		}
		if (!textFound) {
			$('#prevSosText').html('Please contact the following Number: xxx-xxxxxxx');
		}
	});
	</script>
</head>

<body>
	<div data-role="page" id="main">
		<div data-role="header">
			<h1>Config</h1>
		</div>
		<div role="main" class="ui-content">
			<form id="mainForm" action="javascript:saveOptions();">
				<div>
					<h4>Weather-Config</h4>
				</div>
				<div class="ui-field-contain">
					<label for="fsScale">Fahrenheit / Celsius:</label>
					<fieldset data-role="controlgroup" data-type="horizontal" name="fsScale" id="fsScale">
						<input type="radio" name="scale" id="F">
						<label for="F">&deg;F</label>
						<input type="radio" name="scale" id="C">
						<label for="C">&deg;C</label>
					</fieldset>
				</div>
				<div class="ui-field-contain">
					<label for="numberOfDays">Number of forecast days:</label>
					<select name="numberOfDays" id="numberOfDays">
					</select>
				</div>
				<div id="storedCityDiv">
					<label for="storedCityList">Stored Cities:</label>
					<ul id="storedCityList" data-role="listview" data-inset="true" data-split-icon="delete" data-split-theme="d" />
				</div>
				<div>
					<ul id="autocomplete" data-role="listview" data-inset="true" data-filter="true" data-filter-placeholder="Add a new city... (at least 3 characters)" data-filter-theme="a"></ul>
				</div>
				<div id="cityResultDiv">
					<div id="foundCityDiv">
						<label for="foundCityList">Found cities:</label>
						<ul id="foundCityList" data-role="listview" data-inset="true" data-split-icon="plus" data-split-theme="d" />
					</div>
					<div id="foundOneCityDiv">
					</div>
					<div id="foundNoCityDiv">
					</div>
				</div>
				<div>
					<hr />
					<h4>SOS-Card</h4>
				</div>
				<div>
					<label for="sosTitle">Title:</label>
					<input type="text" maxlength="32" name="sosTitle" id="sosTitle" placeholder="Emergency Info:" class="noDefaultAction">
					<label for="sosText">Text:</label>
					<textarea rows="4" cols="16" name="sosText" id="sosText" placeholder="Please contact the following Number: xxx-xxxxxxx"></textarea>
				</div>
				<div class="pebbleWatch">
					<div class="pebblePreviewFrame">
						<div class="pebblePreviewContent">
							<div class="sosWrapper">
								<span class="sosImg"></span>
								<div class="pebbleTitle wordwrapPebble" id="prevSosTitle"></div>
							</div>
							<div class="pebbleText wordwrapPebble" id="prevSosText"></div>
						</div>
					</div>
				</div>
				<div>
					<input type="submit" class="ui-btn" value="Save">
				</div>
			</form>
		</div>
		<div data-role="footer">
			<h4>Have fun!</h4>
		</div>
	</div>

</body>

</html>
